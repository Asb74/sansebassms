workflows:
  build-ios-without-mac:
    name: Build iOS app without Mac
    environment:
      flutter: stable
      xcode: latest
      vars:
        BUNDLE_ID: "com.example.sansebassms"
        APP_STORE_CONNECT_ISSUER_ID: EnTuCuentaDeApple
        APP_STORE_CONNECT_KEY_IDENTIFIER: ABC1234567
        APP_STORE_CONNECT_PRIVATE_KEY: EnBase64TuArchivoP8
    triggering:
      events:
        - push
    scripts:
      - name: Pre-cache and clean
        script: |
          flutter precache --ios
          flutter pub get
          flutter clean

      - name: Patch missing Flutter.podspec
        script: |
          PODSPEC_SOURCE="$FLUTTER_ROOT/bin/cache/artifacts/engine/ios/Flutter.podspec"
          PODSPEC_TARGET="ios/Flutter/Flutter.podspec"
          if [ -f "$PODSPEC_SOURCE" ]; then
            echo "✔ Copiando Flutter.podspec al proyecto..."
            mkdir -p ios/Flutter
            cp "$PODSPEC_SOURCE" "$PODSPEC_TARGET"
          else
            echo "❌ No se encontró Flutter.podspec en $PODSPEC_SOURCE"
            exit 1
          fi

      - name: Build IPA for App Store
        script: |
          flutter build ipa --release \
            --export-options-plist=/Users/builder/export_options.plist

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      app_store_connect:
        auth: app_store_connect_key
        app_id: 1754300715
